<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Afspraak maken</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label, button { margin: 10px 0; display: block; }
    #resultaat { margin-top: 15px; font-weight: bold; }

    #bevestigModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5); z-index: 9999;
      justify-content: center; align-items: center;
    }
    #bevestigModalContent {
      background: white; padding: 20px; border-radius: 10px; max-width: 400px;
      text-align: center;
    }
    #bevestigModalContent button { margin: 5px; }

    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: black;
      color: white;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div id="overlay">Bedankt voor uw reactie</div>

  <h2 id="welkomText">Welkom bewoner</h2>

  <!-- Velden eerst -->
  <label for="email">E-mail:</label>
  <input type="email" id="email" />

  <label for="telefoon">Telefoonnummer:</label>
  <input type="tel" id="telefoon" />

  <label for="opmerking">Opmerking:</label>
  <textarea id="opmerking" rows="3"></textarea>

  <label for="huisnummer">Huisnummer:</label>
  <input type="text" id="huisnummer" readonly />

  <hr />

  <button onclick="kiesActie('afspraak')">‚úÖ Afspraak maken</button>
  <button onclick="kiesActie('weigeren')">‚ùå Ik geef geen toestemming</button>

  <div id="afspraakSectie" style="display:none;">
    <label>Kies √©√©n of meer geplande datums:</label>
    <div id="datumCheckboxes"></div>
    <button type="button" onclick="bevestigAfspraak()">üì§ Bevestig en verzend</button>
  </div>

  <div id="redenKeuze" style="display:none;">
    <label>Waarom geeft u geen toestemming?</label>
    <select id="redenSelect">
      <option value="Niet beschikbaar op geplande datums">Niet beschikbaar op geplande datums</option>
      <option value="Geen interesse">Geen interesse</option>
      <option value="Graag overleg nodig">Graag overleg nodig</option>
    </select>
    <button onclick="submitReden()">Verstuur reden</button>
  </div>

  <div id="resultaat"></div>

  <div id="bevestigModal">
    <div id="bevestigModalContent">
      <p id="modalText">Weet je zeker dat je deze datums wilt bevestigen?</p>
      <button onclick="verzendBevestiging()">‚úÖ Bevestig</button>
      <button onclick="sluitModal()">Annuleer</button>
    </div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyVHrLxedHIuhBdMDD_-OM-mzesKz522FP8purd3y2-SxK9SHiAqF-O3v13WFBrlh4t/exec";

    const urlParams = new URLSearchParams(window.location.search);
    const plaats = urlParams.get("plaats");
    const straat = urlParams.get("straat");
    const huisnummer = urlParams.get("huisnummer");

    let gekozenDatums = [];

    window.addEventListener("load", () => {
      document.getElementById("overlay").style.display = "none";
      document.body.style.pointerEvents = "auto";
      document.getElementById("afspraakSectie").style.display = "none";
      document.getElementById("redenKeuze").style.display = "none";
      document.getElementById("resultaat").innerText = "";
      document.getElementById("datumCheckboxes").innerHTML = "";
      document.getElementById("bevestigModal").style.display = "none";

      if (huisnummer && straat && plaats) {
        document.getElementById("huisnummer").value = huisnummer;
fetch(`${scriptUrl}?action=getAddressDetails&plaats=${encodeURIComponent(plaats)}&straat=${encodeURIComponent(straat)}&huisnummer=${encodeURIComponent(huisnummer)}`)
  .then(r => r.json())
  .then(data => {
    if (!data.error) {
      document.getElementById("welkomText").innerText =
        `Welkom bewoner van de ${data.straat}, ${data.huisnummer}, ${data.plaats}`;
      
      // Vul de velden als er waarden beschikbaar zijn
      if (data.email) document.getElementById("email").value = data.email;
      if (data.telefoon) document.getElementById("telefoon").value = data.telefoon;
      if (data.opmerking) document.getElementById("opmerking").value = data.opmerking;
    } else {
      document.getElementById("welkomText").innerText =
        `Welkom bewoner van huisnummer ${huisnummer}`;
    }
  })

          .catch(() => {
            document.getElementById("welkomText").innerText =
              `Welkom bewoner van huisnummer ${huisnummer}`;
          });
      } else {
        document.getElementById("welkomText").innerText = "Welkom bewoner";
      }
    });

    function kiesActie(type) {
      document.getElementById("resultaat").innerText = "";
      if (type === "afspraak") {
        document.getElementById("afspraakSectie").style.display = "block";
        document.getElementById("redenKeuze").style.display = "none";
        loadAvailableDates();
      } else {
        document.getElementById("afspraakSectie").style.display = "none";
        document.getElementById("redenKeuze").style.display = "block";
      }
    }

    function loadAvailableDates() {
      fetch(`${scriptUrl}?action=getAvailableDates&plaats=${encodeURIComponent(plaats)}&straat=${encodeURIComponent(straat)}&huisnummer=${encodeURIComponent(huisnummer)}`)
        .then(r => r.json())
        .then(data => {
          const container = document.getElementById("datumCheckboxes");
          container.innerHTML = "";
          data.forEach(dateString => {
            const dateObj = new Date(dateString);
            const formatted = dateObj.toLocaleDateString("nl-NL", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric"
            });

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = formatted;
            checkbox.id = `date-${formatted}`;

            const label = document.createElement("label");
            label.htmlFor = `date-${formatted}`;
            label.innerText = formatted;

            const div = document.createElement("div");
            div.appendChild(checkbox);
            div.appendChild(label);
            container.appendChild(div);
          });
        })
        .catch(() => alert("Fout bij ophalen van datums."));
    }

    function bevestigAfspraak() {
      const checkboxes = document.querySelectorAll("#datumCheckboxes input[type='checkbox']");
      gekozenDatums = [...checkboxes].filter(cb => cb.checked).map(cb => cb.value.trim());

      if (gekozenDatums.length === 0) {
        alert("Kies minstens √©√©n datum.");
        return;
      }

      document.getElementById("modalText").innerText =
        `Bevestig je deze datums:\n${gekozenDatums.join(", ")}`;
      document.getElementById("bevestigModal").style.display = "flex";
    }

    function sluitModal() {
      document.getElementById("bevestigModal").style.display = "none";
    }

    function verzendBevestiging() {
      sluitModal();
      const geselecteerdeDatums = gekozenDatums.join(",");

      const email = document.getElementById("email").value.trim();
      const telefoon = document.getElementById("telefoon").value.trim();
      const opmerking = document.getElementById("opmerking").value.trim();

      const url = `${scriptUrl}?action=markAppointment&plaats=${encodeURIComponent(plaats)}&straat=${encodeURIComponent(straat)}&huisnummer=${encodeURIComponent(huisnummer)}&selectedDates=${encodeURIComponent(geselecteerdeDatums)}&email=${encodeURIComponent(email)}&telefoon=${encodeURIComponent(telefoon)}&opmerking=${encodeURIComponent(opmerking)}`;

      fetch(url)
        .then(r => r.text())
        .then(() => toonBedanktOverlay())
        .catch(() => alert("Fout bij versturen afspraak."));
    }

    function submitReden() {
      const reden = document.getElementById("redenSelect").value;
      if (!reden) return alert("Kies een reden.");

      const email = document.getElementById("email").value.trim();
      const telefoon = document.getElementById("telefoon").value.trim();
      const opmerking = document.getElementById("opmerking").value.trim();

      fetch(`${scriptUrl}?action=declineAppointment&plaats=${encodeURIComponent(plaats)}&straat=${encodeURIComponent(straat)}&huisnummer=${encodeURIComponent(huisnummer)}&reason=${encodeURIComponent(reden)}&email=${encodeURIComponent(email)}&telefoon=${encodeURIComponent(telefoon)}&opmerking=${encodeURIComponent(opmerking)}`)
        .then(() => toonBedanktOverlay())
        .catch(() => alert("Fout bij versturen reden."));
    }

    function toonBedanktOverlay() {
      document.getElementById("overlay").style.display = "flex";
      document.body.style.pointerEvents = "none";
      setTimeout(() => {
        try {
          window.close();
        } catch (e) {
          window.location.href = "https://www.google.com";
        }
      }, 5000);
    }
  </script>
</body>
</html>
